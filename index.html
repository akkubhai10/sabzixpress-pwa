<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabziXpress - Fast Delivery</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FFDD00">
    <style>
        /* [FINAL CUSTOM UI STYLES FOR BLINKIT LOOK] */
        .yellow-header {
            background-color: var(--highlight-color);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .yellow-header .container { display: flex; align-items: center; gap: 10px; }
        .location-info { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .search-container {
            background-color: var(--surface-color); border-radius: 12px; display: flex;
            align-items: center; padding: 8px 15px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; display: flex; 
            justify-content: space-around; background-color: var(--surface-color); 
            border-top: 1px solid var(--border-color); z-index: 200; padding: 5px 0; height: 55px; 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary-color); font-size: 10px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item span { font-size: 20px; }
        #sidebar-menu { 
            height: 100%; width: 0; position: fixed; z-index: 300; top: 0; left: 0; 
            background-color: var(--surface-color); overflow-x: hidden; transition: 0.5s; 
            padding-top: 60px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); 
        }
         .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .quantity-control button {
            width: 30px;
            height: 30px;
            padding: 0;
            margin: 0 5px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            background-color: var(--primary-color);
            color: white;
        }
        .quantity-control .qty {
            display: inline-block;
            width: 20px;
            text-align: center;
        }
    </style>
</head>
<body data-theme="light">

    <!-- HAMBURGER MENU (Sidebar) -->
    <div id="sidebar-menu" class="shadow">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="user-profile">
            <h4 id="menu-user-name">Hello, User</h4>
            <p id="menu-user-email"></p>
        </div>
        <a href="#" id="view-orders-link" onclick="showOrderPage()">Your Orders</a>
        <div class="dark-mode-toggle">
            <span>Dark Mode</span>
            <label class="switch"><input type="checkbox" id="dark-mode-switch"><span class="slider round"></span></label>
        </div>
        <a href="#" id="logout-btn" class="btn-block btn secondary">Logout</a>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen active">
        <div class="container">
            <h1>Welcome to SabziXpress</h1>
            <div id="login-view">
                <input type="email" id="login-email" placeholder="Email" autocomplete="email">
                <input type="password" id="login-password" placeholder="Password" autocomplete="current-password">
                <button id="login-btn" class="btn primary">Login</button>
                <p>New here? <a href="#" id="show-signup">Create an account</a></p>
            </div>
            <div id="signup-view" style="display: none;">
                <input type="text" id="signup-name" placeholder="Full Name" autocomplete="name">
                <input type="email" id="signup-email" placeholder="Email" autocomplete="email">
                <input type="password" id="signup-password" placeholder="Password" autocomplete="new-password">
                <button id="signup-btn" class="btn primary">Sign Up</button>
                <p>Already have an account? <a href="#" id="show-login">Login</a></p>
            </div>
        </div>
    </div>

    <!-- LOCATION SCREEN (Address Input) -->
    <div id="location-screen" class="screen" style="display: none;">
        <div class="container">
            <h1>Where should we deliver?</h1>
            <p id="area-status-location">Checking your service area...</p>
            <input type="text" id="address-input" placeholder="Enter Full Address" autocomplete="street-address" required>
            <input type="text" id="pincode-input" placeholder="Pincode" autocomplete="postal-code" required>
            <button id="set-location-btn" class="btn primary">Set Delivery Location</button>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="screen" style="display: none;">
        
        <!-- TOP HEADER -->
        <header class="yellow-header">
            <div class="container">
                <button id="open-nav-btn" class="btn-icon" onclick="openNav()">‚ò∞</button>
                <div style="flex-grow: 1;">
                    <p style="font-size: 12px; margin: 0;">Sabzi Delivery in <span style="font-size: 16px; font-weight: bold;">~20 minutes</span></p>
                    <div class="location-info" id="delivery-location-display">
                        <span id="pincode-display">AREA</span> - <span id="address-display">Address Loading...</span>
                    </div>
                </div>
                <div class="search-container">
                    üîç <input type="text" id="search-input" placeholder="Search for sabzi, dairy..." style="margin-left: 8px;">
                </div>
            </div>
        </header>

        <main class="container" id="main-product-view" style="padding-bottom: 70px;">
            <div id="promo-banners" class="promo-container"></div>
            <section id="categories-section">
                <h3>Categories</h3>
                <div id="categories-grid" class="category-grid"></div>
            </section>
            <section id="products-section">
                <h3 id="product-list-title">All Products</h3>
                <div id="products-grid" class="item-grid"></div>
            </section>
        </main>
        
        <!-- ORDER STATUS VIEW (FANCY PAGE) -->
        <main class="container" id="order-status-page" style="display: none;">
            <h2>Your Current Order</h2>
            <div id="active-order-details" class="status-card-fancy"></div>
            <div id="order-timeline-fancy" class="status-timeline-fancy"></div>
        </main>

        <!-- Cart Floating Button -->
        <button id="cart-fab" class="fab">üõí <span id="cart-count">0</span></button>
        
        <!-- BOTTOM NAVIGATION BAR -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" onclick="showMainView(event)"><span>üè†</span>Home</a>
            <a href="#" class="nav-item" onclick="showOrderPage(event)"><span>üõçÔ∏è</span>Orders</a>
            <a href="#" class="nav-item" onclick="openCart(event)"><span>üõí</span>Basket</a>
        </nav>
    </div>

    <!-- Cart Modal (UPDATED for +/-) -->
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCart()">&times;</span>
            <h2>Your Basket</h2>
            <div id="cart-items"></div>
            <div id="cart-summary">
                <p>Total: <span id="cart-total-display">‚Çπ0.00</span></p>
                <select id="payment-method">
                    <option value="COD">Cash on Delivery (COD)</option>
                    <option value="UPI_ON_DELIVERY">UPI on Delivery</option>
                </select>
                <button id="place-order-btn" class="btn primary btn-block">Place Order</button>
            </div>
        </div>
    </div>
    
    <!-- FIREBASE SDKS (Fixed the Reference Error) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

    <!-- App Logic Scripts -->
    <script src="/js/firebase.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/roles.js"></script>
    <script src="/js/inventory.js"></script>
    <script src="/js/orders.js"></script>
    <script src="/js/notifications.js"></script>
    
    <script>
        // --- CORE UI/UX FUNCTIONS ---
        function openNav() { document.getElementById("sidebar-menu").style.width = "250px"; }
        function closeNav() { document.getElementById("sidebar-menu").style.width = "0"; }
        
        function showView(viewId) {
            document.querySelectorAll('#app-screen main').forEach(m => m.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
        }

        function showMainView(event) {
            if(event) event.preventDefault();
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.bottom-nav a:first-child').classList.add('active');
            showView('main-product-view');
        }

        function showOrderPage(event) {
            if(event) event.preventDefault();
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-orders-link').classList.add('active');
            // Logic to load all past and current orders
            customerCheckForActiveOrder(auth.currentUser.uid);
            showView('order-status-page');
        }
        
        function openCart(event) {
            if(event) event.preventDefault();
            document.getElementById('cart-modal').style.display = 'flex';
        }
        function closeCart() {
            document.getElementById('cart-modal').style.display = 'none';
        }
        
        // --- LOCATION LOGIC ---
        function checkAreaAvailability(pincode) {
            const statusEl = document.getElementById('area-status-location');
            // Mock: Assumes service is available for a few test pincodes
            const serviceablePincodes = ['110001', '000000', '122001'];
            const isServiceable = serviceablePincodes.includes(pincode); 
            
            if (isServiceable) {
                statusEl.textContent = "‚úÖ Great! We deliver to this location.";
                statusEl.style.color = 'var(--success-color)';
                return true;
            } else {
                statusEl.textContent = "‚ùå Sorry, we don't currently serve this area.";
                statusEl.style.color = 'var(--error-color)';
                return false;
            }
        }

        // --- CART LOGIC (WITH +/-) ---
        let cart = [];
        
        window.addToCart = (itemId, name, price, unitType, unitLabel, action = 'add') => {
            const itemIndex = cart.findIndex(item => item.itemId === itemId);
            if (itemIndex > -1) {
                if (action === 'add') cart[itemIndex].quantity++;
                if (action === 'remove') cart[itemIndex].quantity--;
                
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); 
                }
            } else if (action === 'add') {
                cart.push({ itemId, name, price, unitType, unitLabel, quantity: 1 });
            }
            updateCartUI();
        };

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartCountEl = document.getElementById('cart-count');
            const cartTotalEl = document.getElementById('cart-total-display');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            cartCountEl.textContent = totalItems;
            cartTotalEl.textContent = `‚Çπ${totalPrice.toFixed(2)}`;

            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Your basket is empty.</p>';
                document.getElementById('place-order-btn').disabled = true;
                return;
            }

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                cartItemsContainer.innerHTML += `
                    <div class="cart-item">
                        <div style="flex-grow: 1;">
                            <p>${item.name}</p>
                            <p class="price-unit">‚Çπ${item.price} / ${item.unitLabel}</p>
                        </div>
                        <div class="quantity-control">
                            <button class="btn btn-sm" onclick="addToCart('${item.itemId}', '', 0, '', '', 'remove')">-</button>
                            <span class="qty">${item.quantity}</span>
                            <button class="btn btn-sm" onclick="addToCart('${item.itemId}', '${item.name}', ${item.price}, '${item.unitType}', '${item.unitLabel}', 'add')">+</button>
                        </div>
                        <p class="cart-item-total">‚Çπ${itemTotal.toFixed(2)}</p>
                    </div>
                `;
            });
             document.getElementById('place-order-btn').disabled = false;
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth state
            auth.onAuthStateChanged(async user => {
                if (user) {
                    // 1. Role Check
                    await checkUserRole(user.uid, 'Customer', () => {
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('menu-user-name').textContent = `Hello, ${user.displayName || 'Customer'}`;
                        document.getElementById('menu-user-email').textContent = user.email;
                        
                        // 2. Location Check (New Flow)
                        if (localStorage.getItem('userPincode')) {
                            const isServiceable = checkAreaAvailability(localStorage.getItem('userPincode'));
                            if (isServiceable) {
                                document.getElementById('app-screen').style.display = 'block';
                                loadAppContent(user.uid);
                            }
                        } else {
                            document.getElementById('location-screen').style.display = 'block';
                        }
                    });
                } else {
                    document.getElementById('auth-screen').style.display = 'block';
                    document.getElementById('app-screen').style.display = 'none';
                    document.getElementById('location-screen').style.display = 'none';
                }
            });

            // --- LOCATION SUBMIT ---
            document.getElementById('set-location-btn').addEventListener('click', () => {
                const pincode = document.getElementById('pincode-input').value;
                const address = document.getElementById('address-input').value;
                if (!pincode || !address) {
                    alert('Please enter your full address and pincode.');
                    return;
                }
                
                if (checkAreaAvailability(pincode)) {
                    localStorage.setItem('userPincode', pincode);
                    localStorage.setItem('userAddress', address);
                    document.getElementById('app-screen').style.display = 'block';
                    document.getElementById('location-screen').style.display = 'none';
                    loadAppContent(auth.currentUser.uid);
                }
            });
            
            // --- PLACE ORDER ---
             document.getElementById('place-order-btn').addEventListener('click', () => {
                const paymentMethod = document.getElementById('payment-method').value;
                const user = auth.currentUser;
                if (!user || cart.length === 0) {
                    alert('Cannot place order. Please check your basket or login status.');
                    return;
                }
                
                const address = localStorage.getItem('userAddress') || 'N/A';
                const pincode = localStorage.getItem('userPincode') || 'N/A';

                const orderData = {
                    customerId: user.uid,
                    customerName: user.displayName,
                    customerAddress: address,
                    customerPincode: pincode,
                    items: cart,
                    paymentMethod,
                    status: 'PLACED',
                    createdAt: new Date().toISOString(),
                    routeKey: `AREA_${pincode}` 
                };

                placeOrder(orderData).then(() => {
                    alert('Order placed successfully! Check Your Orders in the menu.');
                    cart = [];
                    updateCartUI();
                    closeCart();
                    showOrderPage(); 
                }).catch(error => {
                    console.error("Order placement failed: ", error);
                    alert(`Error placing order: ${error.message}`);
                });
            });

            // --- DARK MODE TOGGLE ---
            document.getElementById('dark-mode-switch').addEventListener('change', (e) => {
                document.body.dataset.theme = e.target.checked ? 'dark' : 'light';
                localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
            });
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.dataset.theme = savedTheme;
            document.getElementById('dark-mode-switch').checked = (savedTheme === 'dark');
             
            // --- SIGNUP/LOGIN TABS ---
            document.getElementById('show-signup').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-view').style.display = 'none'; document.getElementById('signup-view').style.display = 'block'; });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('signup-view').style.display = 'none'; document.getElementById('login-view').style.display = 'block'; });

        });
        
        function loadAppContent(userId) {
            loadBanners();
            loadCategories();
            loadAllProducts();
            customerCheckForActiveOrder(userId);
            
            document.getElementById('delivery-location-display').innerHTML = `
                <span id="pincode-display">${localStorage.getItem('userPincode')}</span> - <span id="address-display">${localStorage.getItem('userAddress').substring(0, 20)}...</span>
            `;
        }
    </script>
</body>
</html>