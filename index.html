<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SabziXpress - Fast Delivery</title>
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FFDD00"> <!-- Blinkit Yellow -->
    <style>
        /* New Custom styles for Blinkit-like UI */
        body { background-color: var(--background-color-light); }
        .yellow-header {
            background-color: var(--highlight-color);
            padding: 15px 0;
            color: var(--text-primary-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .yellow-header .container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .location-info { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .search-container {
            background-color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            padding: 8px 15px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .search-container input {
            border: none;
            flex-grow: 1;
            padding: 0;
            margin: 0;
            outline: none;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background-color: white;
            border-top: 1px solid #eee;
            z-index: 200;
            padding: 5px 0;
            height: 55px;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-secondary-color);
            font-size: 10px;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-item span { font-size: 20px; } /* For icons */

        /* Hamburger Menu (Sidebar) */
        #sidebar-menu {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 300;
            top: 0;
            left: 0;
            background-color: var(--surface-color);
            overflow-x: hidden;
            transition: 0.5s;
            padding-top: 60px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        #sidebar-menu a {
            padding: 15px 25px;
            text-decoration: none;
            font-size: 16px;
            color: var(--text-primary-color);
            display: block;
            transition: 0.3s;
            border-bottom: 1px solid var(--border-color);
        }
        #sidebar-menu a:hover { background-color: var(--background-color-light); }
        .closebtn {
            position: absolute;
            top: 0;
            right: 25px;
            font-size: 36px;
            margin-left: 50px;
        }
        .user-profile { padding: 15px 25px; border-bottom: 2px solid #ddd; }
        .dark-mode-toggle { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; }

        /* Location Screen */
        #location-screen { background-color: var(--highlight-color); text-align: center; }
        #location-screen .container { padding-top: 20vh; }

        /* Order Status Page */
        #order-status-page { padding-bottom: 70px; }
        .status-card-fancy {
            margin-top: 20px;
            padding: 15px;
            border-left: 5px solid var(--primary-color);
        }
        .status-timeline-fancy {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px 0;
        }
        .timeline-step-fancy {
            padding: 10px;
            border-left: 2px solid #ccc;
            position: relative;
        }
        .timeline-step-fancy.active { border-left: 2px solid var(--primary-color); }
        .timeline-step-fancy::before {
            content: '‚Ä¢';
            position: absolute;
            left: -11px;
            top: 10px;
            font-size: 20px;
            line-height: 1;
            color: #ccc;
            background-color: white;
            border-radius: 50%;
        }
        .timeline-step-fancy.active::before { color: var(--primary-color); }
    </style>
</head>
<body data-theme="light">

    <!-- HAMBURGER MENU (Sidebar) -->
    <div id="sidebar-menu" class="shadow">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <div class="user-profile">
            <h4 id="menu-user-name">Hello, Customer</h4>
            <p id="menu-user-email"></p>
        </div>
        
        <a href="#" id="view-orders-link" onclick="showOrderPage()">Your Orders</a>
        <a href="#" id="saved-address-link" onclick="showSaveAddressModal()">Saved Addresses</a>
        <a href="#" id="share-link" onclick="shareApp()">Share App Link</a>
        
        <div class="dark-mode-toggle">
            <span>Dark Mode</span>
            <label class="switch">
                <input type="checkbox" id="dark-mode-switch">
                <span class="slider round"></span>
            </label>
        </div>
        
        <a href="#" id="logout-btn" class="btn-block btn secondary">Logout</a>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="screen active">
        <!-- ... (Same login/signup UI as before) ... -->
    </div>

    <!-- LOCATION SCREEN (New Feature) -->
    <div id="location-screen" class="screen" style="display: none;">
        <div class="container">
            <h1>Where should we deliver?</h1>
            <p id="area-status-location">Checking your service area...</p>
            <input type="text" id="address-input" placeholder="Enter Full Address" autocomplete="street-address" required>
            <input type="text" id="pincode-input" placeholder="Pincode" autocomplete="postal-code" required>
            <button id="set-location-btn" class="btn primary">Set Delivery Location</button>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen" class="screen" style="display: none;">
        
        <!-- TOP YELLOW BLINKIT-STYLE HEADER -->
        <header class="yellow-header">
            <div class="container">
                <button id="open-nav-btn" class="btn-icon" onclick="openNav()">‚ò∞</button>
                <div style="flex-grow: 1;">
                    <p style="font-size: 12px; margin: 0;">Blinkit in <span style="font-size: 16px; font-weight: bold;">18 minutes</span></p>
                    <div class="location-info" id="delivery-location-display">
                        <span id="pincode-display">AREA</span> - <span id="address-display">Union Bank ke</span>
                    </div>
                </div>
                <div class="search-container">
                    üîç <input type="text" id="search-input" placeholder="Search for sabzi, dairy..." style="margin-left: 8px;">
                </div>
            </div>
        </header>

        <main class="container" id="main-product-view" style="padding-bottom: 70px;">
            <!-- Categories/Banners Section -->
            <div id="promo-banners" class="promo-container"></div>
            <section id="categories-section">
                <h3>Categories</h3>
                <div id="categories-grid" class="category-grid"></div>
            </section>

            <!-- Products Section -->
            <section id="products-section">
                <h3 id="product-list-title">All Products</h3>
                <div id="products-grid" class="item-grid"></div>
            </section>
        </main>
        
        <!-- ORDER STATUS VIEW (Moved from Home Screen) -->
        <main class="container" id="order-status-page" style="display: none;">
            <h2>Your Current Order</h2>
            <div id="active-order-details" class="status-card-fancy">
                <!-- Active Order details will be displayed here -->
            </div>
            <div id="order-timeline-fancy" class="status-timeline-fancy">
                <!-- Status timeline will be injected by JS -->
            </div>
        </main>

        <!-- Cart Floating Button -->
        <button id="cart-fab" class="fab">üõí <span id="cart-count">0</span></button>
        
        <!-- BOTTOM NAVIGATION BAR (New) -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" onclick="showMainView(event)"><span>üè†</span>Home</a>
            <a href="#" class="nav-item" onclick="showOrderPage(event)"><span>üõçÔ∏è</span>Order Again</a>
            <a href="#" class="nav-item" onclick="showCategoriesView(event)"><span>::</span>Categories</a>
            <a href="#" class="nav-item" onclick="openCart(event)"><span>üõí</span>Basket</a>
        </nav>
    </div>

    <!-- Cart Modal (Updated for +/- Quantity) -->
    <div id="cart-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCart()">&times;</span>
            <h2>Your Basket</h2>
            <div id="cart-items"></div>
            <div id="cart-summary">
                <p>Total: <span id="cart-total-display">‚Çπ0.00</span></p>
                <h4>Select Payment Method</h4>
                <select id="payment-method">
                    <option value="COD">Cash on Delivery (COD)</option>
                    <option value="UPI_ON_DELIVERY">UPI on Delivery</option>
                </select>
                <button id="place-order-btn" class="btn primary btn-block">Place Order</button>
            </div>
        </div>
    </div>
    
    <!-- Saved Address Modal (New) -->
    <div id="save-address-modal" class="modal">
         <!-- ... (Address form content) ... -->
    </div>
    
    <!-- Firebase SDKs -->
    <!-- ... (SDK imports) ... -->

    <!-- App Logic Scripts -->
    <script src="/js/firebase.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/roles.js"></script>
    <script src="/js/inventory.js"></script>
    <script src="/js/orders.js"></script>
    <script src="/js/notifications.js"></script>

    <script>
        // --- Core UI Management ---
        function openNav() { document.getElementById("sidebar-menu").style.width = "250px"; }
        function closeNav() { document.getElementById("sidebar-menu").style.width = "0"; }
        
        function showView(viewId) {
            document.querySelectorAll('#app-screen main').forEach(m => m.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
        }

        function showMainView(event) {
            if(event) event.preventDefault();
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.bottom-nav a:first-child').classList.add('active');
            showView('main-product-view');
        }

        function showOrderPage(event) {
            if(event) event.preventDefault();
            document.querySelectorAll('.bottom-nav .nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-orders-link').classList.add('active');
            // Logic to load all past and current orders
            customerCheckForActiveOrder(auth.currentUser.uid); // This will show the current order
            showView('order-status-page');
        }
        
        function openCart(event) {
            if(event) event.preventDefault();
            document.getElementById('cart-modal').style.display = 'flex';
        }
        function closeCart() {
            document.getElementById('cart-modal').style.display = 'none';
        }
        
        // --- Location Logic ---
        function checkAreaAvailability(pincode) {
            const statusEl = document.getElementById('area-status-location');
            const mainContent = document.getElementById('main-product-view');
            const appScreen = document.getElementById('app-screen');
            const locationScreen = document.getElementById('location-screen');
            
            // Mock: For simplicity, we assume service is available for a test pincode
            const isServiceable = (pincode === '110001' || pincode === '000000'); 
            
            if (isServiceable) {
                statusEl.textContent = "‚úÖ Great! We deliver to this location.";
                statusEl.style.color = 'var(--success-color)';
                // Transition to main app
                appScreen.style.display = 'block';
                locationScreen.style.display = 'none';
                return true;
            } else {
                statusEl.textContent = "‚ùå Sorry, we don't currently serve this area.";
                statusEl.style.color = 'var(--error-color)';
                return false;
            }
        }

        // --- Cart Logic (Updated) ---
        let cart = [];
        
        window.addToCart = (itemId, name, price, unitType, unitLabel, action = 'add') => {
            const itemIndex = cart.findIndex(item => item.itemId === itemId);
            if (itemIndex > -1) {
                if (action === 'add') cart[itemIndex].quantity++;
                if (action === 'remove') cart[itemIndex].quantity--;
                
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); // Remove item if quantity is zero
                }
            } else if (action === 'add') {
                cart.push({ itemId, name, price, unitType, unitLabel, quantity: 1 });
            }
            updateCartUI();
        };

        function updateCartUI() {
            const cartItemsContainer = document.getElementById('cart-items');
            const cartCountEl = document.getElementById('cart-count');
            const cartTotalEl = document.getElementById('cart-total-display');

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            cartCountEl.textContent = totalItems;
            cartTotalEl.textContent = `‚Çπ${totalPrice.toFixed(2)}`;

            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p>Your basket is empty.</p>';
                document.getElementById('place-order-btn').disabled = true;
                return;
            }

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                cartItemsContainer.innerHTML += `
                    <div class="cart-item">
                        <div style="flex-grow: 1;">
                            <p>${item.name}</p>
                            <p class="price-unit">‚Çπ${item.price} / ${item.unitLabel}</p>
                        </div>
                        <div class="quantity-control">
                            <button class="btn btn-sm" onclick="addToCart('${item.itemId}', '', 0, '', '', 'remove')">-</button>
                            <span class="qty">${item.quantity}</span>
                            <button class="btn btn-sm" onclick="addToCart('${item.itemId}', '${item.name}', ${item.price}, '${item.unitType}', '${item.unitLabel}', 'add')">+</button>
                        </div>
                        <p class="cart-item-total">‚Çπ${itemTotal.toFixed(2)}</p>
                    </div>
                `;
            });
             document.getElementById('place-order-btn').disabled = false;
        }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth state
            auth.onAuthStateChanged(async user => {
                if (user) {
                    // 1. Role Check
                    await checkUserRole(user.uid, 'Customer', () => {
                        document.getElementById('auth-screen').style.display = 'none';
                        document.getElementById('menu-user-name').textContent = `Hello, ${user.displayName || 'Customer'}`;
                        document.getElementById('menu-user-email').textContent = user.email;
                        
                        // 2. Location Check (New Flow)
                        if (localStorage.getItem('userPincode')) {
                            const isServiceable = checkAreaAvailability(localStorage.getItem('userPincode'));
                            if (isServiceable) {
                                document.getElementById('app-screen').style.display = 'block';
                                loadAppContent(user.uid);
                            }
                        } else {
                            // First time user or no location saved
                            document.getElementById('location-screen').style.display = 'block';
                        }
                    });
                } else {
                    document.getElementById('auth-screen').style.display = 'block';
                    document.getElementById('app-screen').style.display = 'none';
                    document.getElementById('location-screen').style.display = 'none';
                }
            });

            // --- Location Submit ---
            document.getElementById('set-location-btn').addEventListener('click', () => {
                const pincode = document.getElementById('pincode-input').value;
                const address = document.getElementById('address-input').value;
                if (!pincode || !address) {
                    alert('Please enter your full address and pincode.');
                    return;
                }
                
                if (checkAreaAvailability(pincode)) {
                    localStorage.setItem('userPincode', pincode);
                    localStorage.setItem('userAddress', address);
                    document.getElementById('delivery-location-display').innerHTML = `
                        <span id="pincode-display">${pincode}</span> - <span id="address-display">${address.substring(0, 20)}...</span>
                    `;
                    document.getElementById('app-screen').style.display = 'block';
                    document.getElementById('location-screen').style.display = 'none';
                    loadAppContent(auth.currentUser.uid);
                }
            });
            
            // --- Place Order ---
             document.getElementById('place-order-btn').addEventListener('click', () => {
                const paymentMethod = document.getElementById('payment-method').value;
                const user = auth.currentUser;
                if (!user || cart.length === 0) {
                    alert('Cannot place order. Please check your basket or login status.');
                    return;
                }
                
                // Get Saved Location
                const address = localStorage.getItem('userAddress') || 'N/A';
                const pincode = localStorage.getItem('userPincode') || 'N/A';

                const orderData = {
                    customerId: user.uid,
                    customerName: user.displayName,
                    customerAddress: address,
                    customerPincode: pincode,
                    items: cart,
                    paymentMethod,
                    status: 'PLACED',
                    createdAt: new Date().toISOString(),
                    // Route key is simple logic for batching/delivery
                    routeKey: `AREA_${pincode}` 
                };

                placeOrder(orderData).then(() => {
                    alert('Order placed successfully! Check Your Orders in the menu.');
                    cart = [];
                    updateCartUI();
                    closeCart();
                    showOrderPage(); // Show the new order status page
                }).catch(error => {
                    console.error("Order placement failed: ", error);
                    alert(`Error placing order: ${error.message}`);
                });
            });

            // --- Dark Mode Toggle ---
            document.getElementById('dark-mode-switch').addEventListener('change', (e) => {
                document.body.dataset.theme = e.target.checked ? 'dark' : 'light';
                localStorage.setItem('theme', e.target.checked ? 'dark' : 'light');
            });
            // Apply saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.dataset.theme = savedTheme;
            document.getElementById('dark-mode-switch').checked = (savedTheme === 'dark');

        });
        
        function loadAppContent(userId) {
            // Load app data
            loadBanners();
            loadCategories();
            loadAllProducts();
            customerCheckForActiveOrder(userId);
            
            // Display location
            document.getElementById('delivery-location-display').innerHTML = `
                <span id="pincode-display">${localStorage.getItem('userPincode')}</span> - <span id="address-display">${localStorage.getItem('userAddress').substring(0, 20)}...</span>
            `;
        }

         // --- Share Function ---
        function shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'SabziXpress - Order Freshness in 18 Minutes!',
                    text: 'Download and install our PWA for fast delivery.',
                    url: 'https://sabzixpress.netlify.app/'
                }).then(() => console.log('Successful share')).catch((error) => console.log('Error sharing', error));
            } else {
                alert(`Please copy this link: https://sabzixpress.netlify.app/ and share!`);
            }
        }
    </script>
</body>
</html>